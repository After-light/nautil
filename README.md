# Nautil

充满创意的JS响应式编程前端框架。

Nautil为“鹦鹉螺”的英文单词前段，鹦鹉螺是一种古老的生物，是一种奇异的生长生物，在腾讯内代表“创新”。

## 项目背景

前端框架的发展非常迅速，但是随着主流框架在架构层面越来越趋于一致，使得前端编程变得古板。以React、Vue为主的编程生态，抹灭了很多编程领域的想法。React解决了一个问题，却带来了更多问题，就像挖了一个沼泽，一旦跳下，就不得不在后来的问题里面不断挣扎。

前端框架的大一统不好，框架架构的思维大一统也不好，我们需要一些多样性，我们需要让"virtual dom是最好的解决方案"这样的错误观念感到耻辱。在我看来，很多方案仅仅是提供了一种选择，很多都不是最好的，甚至连js语言层面的东西也有不同的声音。我认为，这些不同的声音才是最好的，敢用不同的观点去发声才是最好的。

Nautil就是一个不同的声音，它基于RxJS的理念去对待前端编程中的数据流，它热爱原生DOM编程，它有前辈cycle.js，它让前端编程像是在玩乐，它让编程产生兴趣。

## 技术回顾

### 行为交互

在很长一段时间，前端编程主要处理的是交互问题。用户点击界面上的按钮产生的效果，输入表单的效果，鼠标移动的效果信息展示的效果，内容、理念展示的效果。开发者用js去处理用户操作界面后反馈给用户的产品需求，例如slideDown的效果，例如筛选搜索的效果等等。

前端需要处理的很大一个方面，就是对用户的交互需求产生正确的符合用户预期的响应。

为了解决快速急切的解决前端交互问题，jquery诞生了。jquery是一代伟大的产品，它将交互效果进行抽象，不同的效果用一个很简单的方法就可以实现。

### 数据交互

随着前端应用越来越复杂，界面上的交互越来越细，一个web应用逐渐发展为一套系统的UI，而系统越大，逻辑越复杂。越是想搭上web顺风车的企业，越会发现，前端编程异常复杂。因为在单纯处理行为交互的模式下，前端编程需要反复的去处理DOM，反复的用一些不标准的方式去构建、修改DOM结构。这种情况下，MVC呼之欲出，angular是这个时代最伟大的产品之一。

在angular之前，backbone试图解决过数据到界面的问题，但是backbone并不管理数据，它只是提供了一种方法，可以帮助你在交互过程中，得知是否应该修改数据，之后你也可以告知界面是否需要改动。但是，它就是不管理你的数据。不能说backbone失败，但是它确实没有解决数据到界面的问题。而angular解决了，更棒的是，它还解决了DOM操作不标准的问题。用jquery去操作DOM，你只能得到片面的DOM信息，当你要添加DOM的时候，还要手写新的DOM结构，如果一个web应用中需要频繁去写这些东西，会让代码量增大，逻辑复杂，难以维护。而angular用模板代替了这种片面的非标准DOM呈现方式，模板不是真实的视图，但是囊括了真实的视图需要的一切。最伟大的地方在于，angular解决了一个复杂应用中，如何将来自系统底层的数据（或者说通过后台api返回的数据）反应到视图中，让数据驱动视图。数据的变化，会带着界面一起发生变化。

前端管理数据也是前端编程中的一极，它让交互变得更复杂，你不单单要处理对用户行为交互的反馈，还要同时考虑到用户行为交互带来的数据变化情况，并让数据的变动反应到界面中。

### 响应式交互

在angular之后，react和vue以全新的方式重新定义了数据反应到视图的方式。react更进一步，提出jsx，它的本质是替代模板，作为视图编程的另一种存在，这种存在解决了了长期以来的一个问题，就是模板的编译和数据的映射问题，本质上讲，jsx是一系列js函数和方法的语法糖，而非模板，所以不需要编译，不存在要将它像模板一样解析为一套系统规则的过程，它本身就是代表解析后的规则。这样它就解决了angular里面，你需要自己去构建模板，甚至控制如何编译模板的问题。

然而，事情并没有那么顺利，react模拟了一套DOM的事件体系，它让用户与界面之间的交互更难理解，你在react的交互编程这块会被受打击。试用过所有框架之后，所有的前端开发者都会感叹，jquery才是最好的交互编程的工具。

为了解决交互过程与数据的对应关系，rxjs孕育而生。rxjs是基于观察者模式和迭代器模式的函数式编程库，简单的说，它的出现，解决了将用户在界面上的操作映射为数据变化的过程，这比react或angular等框架里面的事件系统要高级很多。当然，rxjs还有更多优秀之处，但在框架的演进层面，它确实提供了一种新的思路去解决用户交互映射到数据变化的问题，有了这样的思维方式，整个js前端框架的结构体系就有了大致轮廓，即：将数据映射到界面中有virtual dom，将界面交互映射到数据中有rxjs。

## 基于流的编程架构

基于上述的思考，Nautil想做的，是将这些模式结合起来，形成一种让开发者体验更舒服的编程方式。在经过对以往模式的分析之后，我发现所有的前端编程，都在围绕三个东西编码：界面、数据、用户行为。这都非常容易理解，但是问题在于，以往的框架在处理这三者关系上，或多或少会有一些瑕疵，以React的事件系统来讲，它完全是抛弃了DOM的事件系统，自己模拟出了一套自己的事件系统，这完全是因为他们在实现react的virtual dom的时候搞出了新问题，为了解决问题而大费周章实现了一套另外的东西，而这套东西，本质上不比DOM的事件系统优秀，它仅仅是因为virtual dom无法使用DOM的事件系统。而Nautil则想把这部分还原本真。

另外，我们还知道Facebook的工程师提出了Flux的数据流管理思想，并且被redux实现了。redux被捧上了神话般的地位。但是很明显，redux的编程模式太过复杂了，它让编程变得不那么有趣，它让那些不愿意讲技术本身，而喜欢谈论玄学的工程师乐此不疲，因为这些人有的是功夫去研究和发挥遐想，但是说真的，他们说的那些虽然很美好，但在实际编程中，真的没什么意义，只有需要那些东西的特殊场景下，才需要用非常复杂，而非带着乐趣的方式去实现他们说的那些神乎其技的能力。Flux思想是很好的，但是它要求太多，它要subscribe，要dispatch，要自己构造state等等，这些都让它在实践中像是给开发者制造麻烦的一个家伙。

我们再去思考一个应用中的数据，你就发现，它实际上只会发生两件事，一件是被取出来去渲染界面，而另一件事是被修改。既然只有两件事，我们为何要使它变得那么复杂呢？问题被搞复杂，是因为大部分人都在考虑一件事，就是“数据在变化”。数据是什么时候变的？数据变的时候，我应该干什么？带着这些问题，开发者越陷越深。在Nautil里面，我把一个应用中数据的变迁脱离出原始概念，在我的设计中，应用本身的数据只被存储在一个地方，它不会随时发生变化，而是在一系列动作之后，得到一个最终的状态。而这一系列动作，需要有一个容器，那就是rxjs里面的“流”的概念。在Nautil中，“流”贯穿了整个应用，它有固定的方向，当应用启动时，它从数据流向视图，而且rxjs的流可以是多值多播的，它从数据流向视图不是一次性的，假如我们的应用中有异步操作，再它第一次流向视图，使得界面呈现初始状态之后，它还可以由于异步动作，将新的数据再次流向视图，使界面发生变化。而当用户在视图中进行了某些操作，那么这些操作产生的流会流进一个action，被其中的代码处理，转化为数据变化规则，从而对数据进行修改，数据修改之后，流继续流向视图，界面继续发生变化。

对于在Nautil中进行编程而言，开发者主要要处理的是流的三个环节：如何在Model中声明数据、控制数据流入流出规则，如何在View中创建视图规则，如何在Conroller中控制事件映射到数据的规则，其他事情，完全交给Nautil去做。

```
   +------>-------(View)------[event]--------+
   |                                         |
   ^                                         |
   |                                         |
(Driver)                                  (Action)
   |                                         |
   |                                         v
   |                                         |
   +-------<------(Model)----[data flow]-----+
```

综上所述，Nautil是一个将应用的数据、视图的状态统一到流中的一个框架。
